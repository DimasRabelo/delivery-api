<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DashboardController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">delivery-api</a> &gt; <a href="index.source.html" class="el_package">com.deliverytech.delivery.controller</a> &gt; <span class="el_source">DashboardController.java</span></div><h1>DashboardController.java</h1><pre class="source lang-java linenums">package com.deliverytech.delivery.controller; // Seu pacote de controller

import io.micrometer.core.instrument.MeterRegistry;
import org.springframework.stereotype.Controller; 
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody; 
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.TimeUnit; 

// ⬇️ 1. IMPORTS NOVOS ⬇️
import com.deliverytech.delivery.service.metrics.MetricsService;
import org.springframework.web.bind.annotation.PathVariable; 

/**
 * Controller para servir o Dashboard HTML
 * e a API de métricas que o alimenta.
 */
@Controller 
@RequestMapping(&quot;/dashboard&quot;)
public class DashboardController {

    private final MeterRegistry meterRegistry;

    // ⬇️ 2. INJEÇÃO NOVA ⬇️
    // Injetamos o MetricsService que criamos na Atividade 2
    private final MetricsService metricsService;

    // ⬇️ 3. CONSTRUTOR ATUALIZADO ⬇️
    // Adicionamos o MetricsService ao construtor
<span class="fc" id="L32">    public DashboardController(MeterRegistry meterRegistry, MetricsService metricsService) {</span>
<span class="fc" id="L33">        this.meterRegistry = meterRegistry;</span>
<span class="fc" id="L34">        this.metricsService = metricsService;</span>
<span class="fc" id="L35">    }</span>

    /**
     * Mapeamento para a página HTML.
     * (Seu método original - 100% correto)
     */
    @GetMapping
    public String dashboard() {
<span class="nc" id="L43">        return &quot;dashboard&quot;; </span>
    }

    /**
     * Endpoint de API que o JavaScript do dashboard vai chamar.
     * (Seu método original - 100% correto)
     */
    @GetMapping(&quot;/api/metrics&quot;)
    @ResponseBody
    public Map&lt;String, Object&gt; getMetricsData() {
<span class="nc" id="L53">        Map&lt;String, Object&gt; metrics = new HashMap&lt;&gt;();</span>

<span class="nc" id="L55">        metrics.put(&quot;pedidos_total&quot;, getCounterValue(&quot;delivery.pedidos.total&quot;));</span>
<span class="nc" id="L56">        metrics.put(&quot;pedidos_sucesso&quot;, getCounterValue(&quot;delivery.pedidos.sucesso&quot;));</span>
<span class="nc" id="L57">        metrics.put(&quot;pedidos_erro&quot;, getCounterValue(&quot;delivery.pedidos.erro&quot;));</span>
<span class="nc" id="L58">        metrics.put(&quot;receita_total&quot;, getCounterValue(&quot;delivery.receita.total&quot;) / 100.0);</span>
<span class="nc" id="L59">        metrics.put(&quot;tempo_medio_pedido&quot;, getTimerMean(&quot;delivery.pedido.processamento.tempo&quot;));</span>
<span class="nc" id="L60">        metrics.put(&quot;tempo_medio_banco&quot;, getTimerMean(&quot;delivery.database.consulta.tempo&quot;));</span>
<span class="nc" id="L61">        metrics.put(&quot;usuarios_ativos&quot;, getGaugeValue(&quot;delivery.usuarios.ativos&quot;));</span>
<span class="nc" id="L62">        metrics.put(&quot;produtos_estoque&quot;, getGaugeValue(&quot;delivery.produtos.estoque&quot;));</span>
        
<span class="nc" id="L64">        return metrics;</span>
    }
    
    // ==========================================================
    // ⬇️ 4. MÉTODO DE TESTE NOVO (HACK) ⬇️
    // ==========================================================
    /**
     * Endpoint de TESTE para simular usuários ativos.
     * Chama o MetricsService para atualizar o Gauge.
     */
    @GetMapping(&quot;/api/set-users/{count}&quot;)
    @ResponseBody
    public String setActiveUsers(
            @PathVariable(&quot;count&quot;) int count) {
        
        // Chama o método do serviço que o gabarito nos deu
<span class="nc" id="L80">        metricsService.setUsuariosAtivos(count);</span>
        
<span class="nc" id="L82">        return &quot;TESTE: Usuários Ativos definido para: &quot; + count;</span>
    }
    // ==========================================================


    // --- Métodos Auxiliares (Seu código original - 100% correto) ---
    
    private double getCounterValue(String name) {
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (meterRegistry.find(name).counter() != null) {</span>
<span class="nc" id="L91">            return meterRegistry.find(name).counter().count();</span>
        }
<span class="nc" id="L93">        return 0.0;</span>
    }

    private double getTimerMean(String name) {
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (meterRegistry.find(name).timer() != null) {</span>
<span class="nc" id="L98">            return meterRegistry.find(name).timer().mean(TimeUnit.MILLISECONDS);</span>
        }
<span class="nc" id="L100">        return 0.0;</span>
    }

    private double getGaugeValue(String name) {
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (meterRegistry.find(name).gauge() != null) {</span>
<span class="nc" id="L105">            return meterRegistry.find(name).gauge().value();</span>
        }
<span class="nc" id="L107">        return 0.0;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>