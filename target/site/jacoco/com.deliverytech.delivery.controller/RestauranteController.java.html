<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RestauranteController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">delivery-api</a> &gt; <a href="index.source.html" class="el_package">com.deliverytech.delivery.controller</a> &gt; <span class="el_source">RestauranteController.java</span></div><h1>RestauranteController.java</h1><pre class="source lang-java linenums">package com.deliverytech.delivery.controller;

import com.deliverytech.delivery.dto.RestauranteDTO;
import com.deliverytech.delivery.dto.response.ApiResponseWrapper;
import com.deliverytech.delivery.dto.response.PagedResponseWrapper;
import com.deliverytech.delivery.dto.response.ProdutoResponseDTO;
import com.deliverytech.delivery.dto.response.RestauranteResponseDTO;
import com.deliverytech.delivery.service.ProdutoService;
import com.deliverytech.delivery.service.RestauranteService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Positive;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.math.BigDecimal;
import java.util.List;

/**
 * Controller para operações de CRUD e consulta relacionadas a Restaurantes.
 *
 * Expõe endpoints públicos (para clientes) e protegidos (para administração
 * e donos de restaurantes).
 */
@Validated // Habilita a validação de parâmetros de método (ex: @Positive nos @PathVariables)
@RestController
@RequestMapping(&quot;/api/restaurantes&quot;)
@Tag(name = &quot;3. Restaurantes&quot;, description = &quot;Operações públicas e privadas relacionadas aos restaurantes&quot;)
<span class="fc" id="L41">public class RestauranteController {</span>

    @Autowired
    private RestauranteService restauranteService;

    @Autowired
    private ProdutoService produtoService;

    /**
     * Cadastra um novo restaurante no sistema.
     * Acesso restrito a usuários com a role 'ADMIN'.
     *
     * @param dto DTO contendo os dados do novo restaurante.
     * @return ResponseEntity 201 (Created) com os dados do restaurante criado.
     */
    @PostMapping
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    @Operation(summary = &quot;Cadastrar restaurante (ADMIN)&quot;,
               description = &quot;Cria um novo restaurante no sistema. Requer permissão de ADMIN.&quot;)
    @ApiResponses({
            @ApiResponse(responseCode = &quot;201&quot;, description = &quot;Restaurante criado com sucesso&quot;),
            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Dados inválidos&quot;),
            @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Token ausente ou inválido&quot;),
            @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Acesso negado (não é ADMIN)&quot;),
            @ApiResponse(responseCode = &quot;409&quot;, description = &quot;Restaurante já existe (ex: CNPJ duplicado)&quot;)
    })
    @SecurityRequirement(name = &quot;bearerAuth&quot;) // Indica ao Swagger que este endpoint é protegido
    public ResponseEntity&lt;ApiResponseWrapper&lt;RestauranteResponseDTO&gt;&gt; cadastrar(
            @Valid @RequestBody RestauranteDTO dto) {

<span class="nc" id="L71">        RestauranteResponseDTO restaurante = restauranteService.cadastrarRestaurante(dto);</span>
<span class="nc" id="L72">        ApiResponseWrapper&lt;RestauranteResponseDTO&gt; response =</span>
                new ApiResponseWrapper&lt;&gt;(true, restaurante, &quot;Restaurante criado com sucesso&quot;);

<span class="nc" id="L75">        return ResponseEntity.status(HttpStatus.CREATED).body(response);</span>
    }

    /**
     * Lista todos os restaurantes de forma paginada.
     * Permite filtrar por categoria e status (ativo). Endpoint público.
     *
     * @param categoria (Opcional) Filtra restaurantes pela categoria.
     * @param ativo     (Opcional) Filtra restaurantes pelo status (true/false).
     * @param pageable  Objeto de paginação (tamanho, página, ordenação).
     * @return ResponseEntity 200 (OK) com a página de restaurantes.
     */
    @GetMapping
    @Operation(summary = &quot;Listar restaurantes (Público)&quot;,
               description = &quot;Lista restaurantes com filtros opcionais e paginação.&quot;)
    public ResponseEntity&lt;PagedResponseWrapper&lt;RestauranteResponseDTO&gt;&gt; listar(
            @Parameter(description = &quot;Categoria do restaurante&quot;) @RequestParam(required = false) String categoria,
            @Parameter(description = &quot;Status ativo do restaurante&quot;) @RequestParam(required = false) Boolean ativo,
            @Parameter(description = &quot;Parâmetros de paginação&quot;) Pageable pageable) {

<span class="nc" id="L95">        Page&lt;RestauranteResponseDTO&gt; restaurantes = restauranteService.listarRestaurantes(categoria, ativo, pageable);</span>
<span class="nc" id="L96">        PagedResponseWrapper&lt;RestauranteResponseDTO&gt; response = new PagedResponseWrapper&lt;&gt;(restaurantes);</span>
<span class="nc" id="L97">        return ResponseEntity.ok(response);</span>
    }

    /**
     * Busca um restaurante específico pelo seu ID. Endpoint público.
     *
     * @param id O ID (Long) do restaurante.
     * @return ResponseEntity 200 (OK) com os dados do restaurante.
     */
    @GetMapping(&quot;/{id}&quot;)
    @Operation(summary = &quot;Buscar restaurante por ID (Público)&quot;,
               description = &quot;Recupera um restaurante específico pelo ID.&quot;)
    @ApiResponses({
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Restaurante encontrado&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Restaurante não encontrado&quot;)
    })
    public ResponseEntity&lt;ApiResponseWrapper&lt;RestauranteResponseDTO&gt;&gt; buscarPorId(
            @PathVariable @Positive(message = &quot;O ID deve ser positivo&quot;) Long id) {

<span class="nc" id="L116">        RestauranteResponseDTO restaurante = restauranteService.buscarRestaurantePorId(id);</span>
<span class="nc" id="L117">        ApiResponseWrapper&lt;RestauranteResponseDTO&gt; response =</span>
                new ApiResponseWrapper&lt;&gt;(true, restaurante, &quot;Restaurante encontrado&quot;);
<span class="nc" id="L119">        return ResponseEntity.ok(response);</span>
    }

    /**
     * Atualiza os dados de um restaurante existente.
     * Acesso restrito a 'ADMIN' ou ao dono do restaurante.
     *
     * @param id  O ID do restaurante a ser atualizado.
     * @param dto DTO com os novos dados.
     * @return ResponseEntity 200 (OK) com os dados atualizados do restaurante.
     */
    @PutMapping(&quot;/{id}&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN') or @restauranteService.isOwner(#id)&quot;)
    @Operation(summary = &quot;Atualizar restaurante (ADMIN ou Dono)&quot;,
               description = &quot;Atualiza os dados de um restaurante. Requer ADMIN ou ser o dono do restaurante.&quot;)
    @ApiResponses({
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Restaurante atualizado com sucesso&quot;),
            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Dados inválidos&quot;),
            @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Token ausente ou inválido&quot;),
            @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Acesso negado (não é ADMIN ou dono)&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Restaurante não encontrado&quot;)
    })
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    public ResponseEntity&lt;ApiResponseWrapper&lt;RestauranteResponseDTO&gt;&gt; atualizar(
            @PathVariable @Positive(message = &quot;O ID deve ser positivo&quot;) Long id,
            @Valid @RequestBody RestauranteDTO dto) {

<span class="nc" id="L146">        RestauranteResponseDTO restaurante = restauranteService.atualizarRestaurante(id, dto);</span>
<span class="nc" id="L147">        ApiResponseWrapper&lt;RestauranteResponseDTO&gt; response =</span>
                new ApiResponseWrapper&lt;&gt;(true, restaurante, &quot;Restaurante atualizado com sucesso&quot;);

<span class="nc" id="L150">        return ResponseEntity.ok(response);</span>
    }

    /**
     * Altera o status (ativo/inativo) de um restaurante.
     * Acesso restrito a usuários com a role 'ADMIN'.
     *
     * @param id O ID do restaurante a ter o status alterado.
     * @return ResponseEntity 200 (OK) com os dados do restaurante e o novo status.
     */
    @PatchMapping(&quot;/{id}/status&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    @Operation(summary = &quot;Ativar/Desativar restaurante (ADMIN)&quot;,
               description = &quot;Alterna o status ativo/inativo do restaurante. Requer permissão de ADMIN.&quot;)
    @ApiResponses({
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Status alterado com sucesso&quot;),
            @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Token ausente ou inválido&quot;),
            @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Acesso negado (não é ADMIN)&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Restaurante não encontrado&quot;)
    })
    @SecurityRequirement(name = &quot;bearerAuth&quot;)
    public ResponseEntity&lt;ApiResponseWrapper&lt;RestauranteResponseDTO&gt;&gt; alterarStatus(
            @PathVariable @Positive(message = &quot;O ID deve ser positivo&quot;) Long id) {

<span class="nc" id="L174">        RestauranteResponseDTO restaurante = restauranteService.alterarStatusRestaurante(id);</span>
<span class="nc" id="L175">        ApiResponseWrapper&lt;RestauranteResponseDTO&gt; response =</span>
                new ApiResponseWrapper&lt;&gt;(true, restaurante, &quot;Status alterado com sucesso&quot;);

<span class="nc" id="L178">        return ResponseEntity.ok(response);</span>
    }

    /**
     * Busca restaurantes por uma categoria específica. Endpoint público.
     *
     * @param categoria O nome da categoria (ex: &quot;Japonesa&quot;, &quot;Pizza&quot;).
     * @return ResponseEntity 200 (OK) com a lista de restaurantes encontrados.
     */
    @GetMapping(&quot;/categoria/{categoria}&quot;)
    @Operation(summary = &quot;Buscar por categoria (Público)&quot;,
               description = &quot;Lista restaurantes de uma categoria específica.&quot;)
    @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Restaurantes encontrados&quot;)
    public ResponseEntity&lt;ApiResponseWrapper&lt;List&lt;RestauranteResponseDTO&gt;&gt;&gt; buscarPorCategoria(
            @PathVariable @NotBlank(message = &quot;A categoria não pode ser vazia&quot;) String categoria) {

<span class="nc" id="L194">        List&lt;RestauranteResponseDTO&gt; restaurantes = restauranteService.buscarRestaurantesPorCategoria(categoria);</span>
<span class="nc" id="L195">        ApiResponseWrapper&lt;List&lt;RestauranteResponseDTO&gt;&gt; response =</span>
                new ApiResponseWrapper&lt;&gt;(true, restaurantes, &quot;Restaurantes encontrados&quot;);

<span class="nc" id="L198">        return ResponseEntity.ok(response);</span>
    }

    /**
     * Calcula a taxa de entrega de um restaurante para um CEP de destino. Endpoint público.
     *
     * @param id  O ID do restaurante.
     * @param cep O CEP de destino para o cálculo.
     * @return ResponseEntity 200 (OK) com o valor da taxa.
     */
    @GetMapping(&quot;/{id}/taxa-entrega/{cep}&quot;)
    @Operation(summary = &quot;Calcular taxa de entrega (Público)&quot;,
               description = &quot;Calcula a taxa de entrega para um CEP específico a partir de um restaurante.&quot;)
    @ApiResponses({
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Taxa calculada com sucesso&quot;),
            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;CEP inválido&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Restaurante não encontrado&quot;)
    })
    public ResponseEntity&lt;ApiResponseWrapper&lt;BigDecimal&gt;&gt; calcularTaxaEntrega(
            @PathVariable @Positive(message = &quot;O ID deve ser positivo&quot;) Long id,
            @PathVariable @NotBlank(message = &quot;O CEP é obrigatório&quot;) String cep) {

<span class="nc" id="L220">        BigDecimal taxa = restauranteService.calcularTaxaEntrega(id, cep);</span>
<span class="nc" id="L221">        ApiResponseWrapper&lt;BigDecimal&gt; response =</span>
                new ApiResponseWrapper&lt;&gt;(true, taxa, &quot;Taxa calculada com sucesso&quot;);

<span class="nc" id="L224">        return ResponseEntity.ok(response);</span>
    }

    /**
     * Lista restaurantes próximos a um CEP, dentro de um raio (em km). Endpoint público.
     *
     * @param cep  O CEP de referência.
     * @param raio O raio de busca em quilômetros (padrão 10km).
     * @return ResponseEntity 200 (OK) com a lista de restaurantes próximos.
     */
    @GetMapping(&quot;/proximos/{cep}&quot;)
    @Operation(summary = &quot;Restaurantes próximos (Público)&quot;,
               description = &quot;Lista restaurantes próximos a um CEP, baseado em um raio (km).&quot;)
    @ApiResponses({
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Restaurantes próximos encontrados&quot;),
            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;CEP inválido&quot;)
    })
    public ResponseEntity&lt;ApiResponseWrapper&lt;List&lt;RestauranteResponseDTO&gt;&gt;&gt; buscarProximos(
            @PathVariable @NotBlank(message = &quot;O CEP é obrigatório&quot;) String cep,
            @RequestParam(defaultValue = &quot;10&quot;) @Positive(message = &quot;O raio deve ser positivo&quot;) Integer raio) {

<span class="nc" id="L245">        List&lt;RestauranteResponseDTO&gt; restaurantes = restauranteService.buscarRestaurantesProximos(cep, raio);</span>
<span class="nc" id="L246">        ApiResponseWrapper&lt;List&lt;RestauranteResponseDTO&gt;&gt; response =</span>
                new ApiResponseWrapper&lt;&gt;(true, restaurantes, &quot;Restaurantes próximos encontrados&quot;);

<span class="nc" id="L249">        return ResponseEntity.ok(response);</span>
    }

    /**
     * Lista todos os produtos (cardápio) de um restaurante específico. Endpoint público.
     *
     * @param restauranteId O ID do restaurante.
     * @param disponivel    (Opcional) Filtra produtos pelo status (true/false).
     * @return ResponseEntity 200 (OK) com a lista de produtos.
     */
    @GetMapping(&quot;/{restauranteId}/produtos&quot;)
    @Operation(summary = &quot;Produtos do restaurante (Público)&quot;,
               description = &quot;Lista todos os produtos (cardápio) de um restaurante.&quot;)
    @ApiResponses({
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Produtos encontrados&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Restaurante não encontrado&quot;)
    })
    public ResponseEntity&lt;ApiResponseWrapper&lt;List&lt;ProdutoResponseDTO&gt;&gt;&gt; buscarProdutosDoRestaurante(
            @PathVariable @Positive(message = &quot;O ID deve ser positivo&quot;) Long restauranteId,
            @RequestParam(required = false) Boolean disponivel) {

<span class="nc" id="L270">        List&lt;ProdutoResponseDTO&gt; produtos = produtoService.buscarProdutosPorRestaurante(restauranteId, disponivel);</span>
<span class="nc" id="L271">        ApiResponseWrapper&lt;List&lt;ProdutoResponseDTO&gt;&gt; response =</span>
                new ApiResponseWrapper&lt;&gt;(true, produtos, &quot;Produtos encontrados&quot;);

<span class="nc" id="L274">        return ResponseEntity.ok(response);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>