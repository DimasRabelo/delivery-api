<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JwtUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">delivery-api</a> &gt; <a href="index.source.html" class="el_package">com.deliverytech.delivery.security.jwt</a> &gt; <span class="el_source">JwtUtil.java</span></div><h1>JwtUtil.java</h1><pre class="source lang-java linenums">package com.deliverytech.delivery.security.jwt;

import com.deliverytech.delivery.entity.Usuario;
import com.deliverytech.delivery.entity.Cliente; // IMPORT ADICIONADO
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.ExpiredJwtException;
// --- IMPORTAÇÕES AGORA USADAS ---
import io.jsonwebtoken.JwtException; 
import io.jsonwebtoken.MalformedJwtException; 
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import io.jsonwebtoken.security.SignatureException; 
import io.jsonwebtoken.Jwts;
// --- FIM DAS IMPORTAÇÕES ---
import org.slf4j.Logger; // &lt;-- IMPORT ADICIONADO
import org.slf4j.LoggerFactory; // &lt;-- IMPORT ADICIONADO
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Component;

import javax.crypto.SecretKey;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Function;

@Component
<span class="fc" id="L28">public class JwtUtil {</span>

    // Adiciona um logger para registrar falhas de token
<span class="fc" id="L31">    private static final Logger logger = LoggerFactory.getLogger(JwtUtil.class);</span>

    // ... (Configuração - secret, expiration, getSigningKey - OK) ...
    @Value(&quot;${app.jwt.secret}&quot;)
    private String secret;
    @Value(&quot;${app.jwt.expiration-ms}&quot;)
    private long expiration;
    private SecretKey getSigningKey() {
<span class="nc" id="L39">        return Keys.hmacShaKeyFor(secret.getBytes());</span>
    }


    // -------------------------------------------------------------------------
    // Geração de Token (MÉTODO CORRIGIDO)
    // -------------------------------------------------------------------------
    public String generateToken(UserDetails userDetails) {
<span class="nc" id="L47">        Map&lt;String, Object&gt; claims = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L49" title="All 2 branches missed.">        if (userDetails instanceof Usuario usuario) {</span>
<span class="nc" id="L50">            claims.put(&quot;userId&quot;, usuario.getId());</span>
<span class="nc" id="L51">            claims.put(&quot;role&quot;, usuario.getRole().name());</span>
            
            // --- CORREÇÃO (GARGALO 4 / DECISÃO 1) ---
<span class="nc" id="L54">            Cliente cliente = usuario.getCliente();</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">            if (cliente != null) {</span>
<span class="nc" id="L56">                claims.put(&quot;nome&quot;, cliente.getNome()); // &lt;-- CORRIGIDO</span>
            } else {
<span class="nc" id="L58">                claims.put(&quot;nome&quot;, null); // (Admin/Restaurante não tem 'nome' no perfil)</span>
            }
            // --- FIM DA CORREÇÃO ---
            
<span class="nc bnc" id="L62" title="All 2 branches missed.">            if (usuario.getRestauranteId() != null) {</span>
<span class="nc" id="L63">                claims.put(&quot;restauranteId&quot;, usuario.getRestauranteId());</span>
            }
        }

<span class="nc" id="L67">        Date now = new Date();</span>
<span class="nc" id="L68">        Date exp = new Date(now.getTime() + expiration);</span>

<span class="nc" id="L70">        return Jwts.builder()</span>
<span class="nc" id="L71">                .setClaims(claims)</span>
<span class="nc" id="L72">                .setSubject(userDetails.getUsername()) </span>
<span class="nc" id="L73">                .setIssuedAt(now)</span>
<span class="nc" id="L74">                .setExpiration(exp)</span>
<span class="nc" id="L75">                .signWith(getSigningKey(), SignatureAlgorithm.HS256)</span>
<span class="nc" id="L76">                .compact();</span>
    }

    // -------------------------------------------------------------------------
    // Extração de Claims (Leitura do Token)
    // -------------------------------------------------------------------------

    public &lt;T&gt; T extractClaim(String token, Function&lt;Claims, T&gt; claimsResolver) {
<span class="nc" id="L84">        final Claims claims = extractAllClaims(token);</span>
<span class="nc" id="L85">        return claimsResolver.apply(claims);</span>
    }

    private Claims extractAllClaims(String token) 
            throws ExpiredJwtException, SignatureException, MalformedJwtException, JwtException {
<span class="nc" id="L90">        return Jwts.parserBuilder()</span>
<span class="nc" id="L91">                .setSigningKey(getSigningKey())</span>
<span class="nc" id="L92">                .build()</span>
<span class="nc" id="L93">                .parseClaimsJws(token)</span>
<span class="nc" id="L94">                .getBody();</span>
    }

    public String extractUsername(String token) {
<span class="nc" id="L98">        return extractClaim(token, Claims::getSubject);</span>
    }

    public Date extractExpiration(String token) {
<span class="nc" id="L102">        return extractClaim(token, Claims::getExpiration);</span>
    }

    // -------------------------------------------------------------------------
    // Validação do Token (MÉTODO CORRIGIDO PARA USAR OS IMPORTS)
    // -------------------------------------------------------------------------

    public boolean isTokenExpired(String token) {
        try {
<span class="nc" id="L111">            return extractExpiration(token).before(new Date());</span>
<span class="nc" id="L112">        } catch (ExpiredJwtException e) {</span>
<span class="nc" id="L113">            return true;</span>
        }
    }

    public boolean validateToken(String token, UserDetails userDetails) {
        try {
<span class="nc" id="L119">            final String username = extractUsername(token);</span>
<span class="nc bnc" id="L120" title="All 4 branches missed.">            return (username.equals(userDetails.getUsername()) &amp;&amp; !isTokenExpired(token));</span>
        
        // --- AGORA AS IMPORTAÇÕES SÃO USADAS ---
<span class="nc" id="L123">        } catch (SignatureException e) {</span>
<span class="nc" id="L124">            logger.warn(&quot;Token JWT com assinatura inválida: {}&quot;, e.getMessage());</span>
<span class="nc" id="L125">        } catch (MalformedJwtException e) {</span>
<span class="nc" id="L126">            logger.warn(&quot;Token JWT malformado: {}&quot;, e.getMessage());</span>
<span class="nc" id="L127">        } catch (ExpiredJwtException e) {</span>
<span class="nc" id="L128">            logger.warn(&quot;Token JWT expirado: {}&quot;, e.getMessage());</span>
<span class="nc" id="L129">        } catch (JwtException e) { // Pega qualquer outro erro</span>
<span class="nc" id="L130">            logger.warn(&quot;Erro inesperado no token JWT: {}&quot;, e.getMessage());</span>
<span class="nc" id="L131">        }</span>
        
<span class="nc" id="L133">        return false;</span>
    }

    // ... (Restante dos métodos: extractUserId, extractRole, etc. - OK) ...
    public Long extractUserId(String token) {
<span class="nc" id="L138">        return extractClaim(token, claims -&gt; claims.get(&quot;userId&quot;, Long.class));</span>
    }
    public String extractRole(String token) {
<span class="nc" id="L141">        return extractClaim(token, claims -&gt; claims.get(&quot;role&quot;, String.class));</span>
    }
    public Long extractRestauranteId(String token) {
<span class="nc" id="L144">        return extractClaim(token, claims -&gt; claims.get(&quot;restauranteId&quot;, Long.class));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>