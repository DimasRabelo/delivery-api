<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SecurityUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">delivery-api</a> &gt; <a href="index.source.html" class="el_package">com.deliverytech.delivery.security.jwt</a> &gt; <span class="el_source">SecurityUtils.java</span></div><h1>SecurityUtils.java</h1><pre class="source lang-java linenums">package com.deliverytech.delivery.security.jwt;

import com.deliverytech.delivery.entity.Usuario;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;

/**
 * Classe utilitária (Helper) para acessar facilmente os dados do usuário
 * autenticado no sistema.
 *
 * Esta classe centraliza a lógica de busca do usuário no
 * {@link SecurityContextHolder}, simplificando o código em
 * Services e Controllers que precisam saber &quot;quem é o usuário logado&quot;.
 *
 * A maioria dos métodos é estática para permitir acesso direto
 * (ex: {@code SecurityUtils.getCurrentUserId()}).
 */
<span class="nc" id="L19">public class SecurityUtils {</span>

    /**
     * Obtém a entidade {@link Usuario} completa do usuário atualmente autenticado.
     *
     * Este é o método central da classe, buscando o 'Principal' no contexto de segurança
     * e fazendo o &quot;cast&quot; para a nossa entidade {@link Usuario}.
     *
     * @return A entidade {@link Usuario} logada.
     * @throws RuntimeException Se não houver usuário autenticado no contexto
     * ou se o 'Principal' não for uma instância de {@link Usuario}.
     */
    public static Usuario getCurrentUser() {
<span class="fc" id="L32">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>

        // Verifica se existe autenticação e se o &quot;principal&quot; (usuário)
        // é do tipo que esperamos (UserDetails, que nossa entidade Usuario implementa).
<span class="pc bpc" id="L36" title="2 of 4 branches missed.">        if (authentication != null &amp;&amp; authentication.getPrincipal() instanceof UserDetails) {</span>
            // Faz o cast seguro para nossa entidade
<span class="fc" id="L38">            return (Usuario) authentication.getPrincipal();</span>
        }

        // Lança uma exceção se ninguém estiver logado.
        // Isso evita NullPointerExceptions nos métodos que chamam este.
<span class="nc" id="L43">        throw new RuntimeException(&quot;Usuário não autenticado&quot;);</span>
    }

    /**
     * Atalho para obter o ID do usuário logado.
     *
     * @return O ID (Long) do usuário.
     * @throws RuntimeException Se não houver usuário autenticado.
     */
    public static Long getCurrentUserId() {
<span class="fc" id="L53">        return getCurrentUser().getId();</span>
    }

    /**
     * Atalho para obter o Email (username) do usuário logado.
     *
     * @return O Email (String) do usuário.
     * @throws RuntimeException Se não houver usuário autenticado.
     */
    public static String getCurrentUserEmail() {
<span class="nc" id="L63">        return getCurrentUser().getEmail();</span>
    }

    /**
     * Atalho para obter a Role (como String) do usuário logado.
     *
     * @return O nome da Role (ex: &quot;CLIENTE&quot;, &quot;ADMIN&quot;).
     * @throws RuntimeException Se não houver usuário autenticado.
     */
    public static String getCurrentUserRole() {
<span class="nc" id="L73">        return getCurrentUser().getRole().name();</span>
    }

    /**
     * Atalho para obter o ID do restaurante associado ao usuário logado.
     *
     * @return O ID do restaurante (Long), ou 'null' se não houver.
     * @throws RuntimeException Se não houver usuário autenticado.
     */
    public static Long getCurrentRestauranteId() {
<span class="nc" id="L83">        Usuario usuario = getCurrentUser();</span>
<span class="nc" id="L84">        return usuario.getRestauranteId();</span>
    }

    /**
     * Verifica se o usuário logado possui uma role específica.
     *
     * @param role O nome da role a ser verificada (ex: &quot;ADMIN&quot;).
     * @return 'true' se o usuário tiver a role, 'false' caso contrário
     * (ou se nenhum usuário estiver logado).
     */
    public static boolean hasRole(String role) {
        try {
<span class="nc" id="L96">            Usuario usuario = getCurrentUser();</span>
<span class="nc" id="L97">            return usuario.getRole().name().equals(role);</span>
<span class="nc" id="L98">        } catch (Exception e) {</span>
            // Se getCurrentUser() lançar exceção (ninguém logado),
            // o usuário com certeza não tem a role.
<span class="nc" id="L101">            return false;</span>
        }
    }

    // -------------------------------------------------------------------------
    // Atalhos de verificação de Role
    // -------------------------------------------------------------------------

    /** @return 'true' se o usuário logado for ADMIN, 'false' caso contrário. */
    public static boolean isAdmin() {
<span class="nc" id="L111">        return hasRole(&quot;ADMIN&quot;);</span>
    }

    /** @return 'true' se o usuário logado for CLIENTE, 'false' caso contrário. */
    public static boolean isCliente() {
<span class="nc" id="L116">        return hasRole(&quot;CLIENTE&quot;);</span>
    }

    /** @return 'true' se o usuário logado for RESTAURANTE, 'false' caso contrário. */
    public static boolean isRestaurante() {
<span class="nc" id="L121">        return hasRole(&quot;RESTAURANTE&quot;);</span>
    }

    /** @return 'true' se o usuário logado for ENTREGADOR, 'false' caso contrário. */
    public static boolean isEntregador() {
<span class="nc" id="L126">        return hasRole(&quot;ENTREGADOR&quot;);</span>
    }

    // -------------------------------------------------------------------------
    // Métodos de Instância (para Injeção de Dependência)
    // -------------------------------------------------------------------------

    /**
     * Método não-estático que atua como um wrapper para {@link #getCurrentUser()}.
     *
     * Este método provavelmente existe para permitir que a classe {@code SecurityUtils}
     * seja injetada como um Bean Spring (ex: no {@code ProdutoServiceImpl})
     * em vez de chamar o método estático diretamente.
     *
     * @return A entidade {@link Usuario} logada.
     * @throws RuntimeException Se não houver usuário autenticado.
     */
    public Usuario getUsuarioLogado() {
<span class="nc" id="L144">        return getCurrentUser(); // Apenas chama o método estático</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>